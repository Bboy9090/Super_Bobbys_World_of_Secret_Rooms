name: CI Guardrails

on:
  pull_request:
  push:
    branches: [ main ]

# Set minimal permissions for security
permissions:
  contents: read

jobs:
  # Block output artifacts from being edited
  block-output-edits:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Block edits to generated artifacts
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check for edits to output directories
          BLOCKED_PATTERNS="^(dist/|build/|coverage/|out/|target/release/|node_modules/|__pycache__/)"
          BLOCKED_FILES=$(echo "$CHANGED_FILES" | grep -E "$BLOCKED_PATTERNS" || true)
          
          if [ -n "$BLOCKED_FILES" ]; then
            echo "❌ ERROR: Changes detected in generated/output directories:"
            echo "$BLOCKED_FILES"
            echo ""
            echo "These directories should not be edited directly:"
            echo "  - dist/, build/, out/ → Generated by build process"
            echo "  - coverage/ → Generated by test coverage"
            echo "  - target/release/ → Rust build artifacts"
            echo "  - node_modules/ → npm dependencies"
            echo ""
            echo "If you need to change the output, modify the source code instead."
            exit 1
          fi
          
          echo "✅ No edits to generated artifacts detected"

  no-placeholders:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Fail if placeholder keywords exist outside tests
        run: |
          set -e
          # Only scan non-test code; adjust exclusions as needed
          # If ripgrep isn't present, install it.
          if ! command -v rg >/dev/null 2>&1; then sudo apt-get update && sudo apt-get install -y ripgrep; fi
          echo "Scanning for placeholder keywords outside tests..."
          rg -n --hidden --no-ignore-vcs \
            -S "(TODO|FIXME|HACK|STUB|MOCK|PLACEHOLDER|COMING SOON|dummy data|fake success)" \
            . \
            --glob "!tests/**" \
            --glob "!**/*.test.*" \
            --glob "!**/*.spec.*" \
            --glob "!.git/**" \
            --glob "!.github/**" \
            --glob "!dist/**" \
            --glob "!build/**" \
            --glob "!node_modules/**" \
            --glob "!**/__pycache__/**" \
            --glob "!*.md" \
            && { echo "❌ Placeholders found in non-test code. Purge or gate behind EXPERIMENTAL (OFF by default)."; exit 1; } \
            || echo "✅ No placeholder keywords detected outside tests."

  no-build-artifacts:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Block edits to dist/build/output folders
        run: |
          set -e
          echo "Checking for modified build artifacts..."
          
          # Get list of changed files in this PR/push
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # For push events, compare with parent commit
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi
          
          # List changed files matching build artifact patterns
          CHANGED_ARTIFACTS=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -E '\.(exe|pkg|dmg|zip|tar\.gz|deb|rpm|app)$|^dist/|^build/|^out/|^target/release/' || true)
          
          if [ -n "$CHANGED_ARTIFACTS" ]; then
            echo "❌ Build artifacts should not be committed:"
            echo "$CHANGED_ARTIFACTS"
            echo ""
            echo "These files should be in .gitignore and built during CI/CD."
            exit 1
          else
            echo "✅ No build artifacts detected in changes."
          fi

  dangerous-patterns:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Scan for suspicious patterns
        run: |
          set -e
          if ! command -v rg >/dev/null 2>&1; then sudo apt-get update && sudo apt-get install -y ripgrep; fi
          
          echo "Scanning for dangerous patterns..."
          FOUND_ISSUES=0
          
          # Check for shell piping (curl | sh)
          if rg -n "curl.*\|.*sh" . --glob "!.git/**" --glob "!.github/**" --glob "!node_modules/**" 2>/dev/null; then
            echo "❌ Found curl | sh pattern (security risk)"
            FOUND_ISSUES=1
          fi
          
          # Check for rm -rf in scripts without safety checks
          if rg -n "rm\s+-rf\s+/" . --glob "**/*.sh" --glob "**/*.bat" --glob "**/*.ps1" 2>/dev/null; then
            echo "❌ Found 'rm -rf /' pattern (dangerous)"
            FOUND_ISSUES=1
          fi
          
          # Check for eval with user input (Python)
          if rg -n "eval\(.*input" . --glob "**/*.py" --glob "!tests/**" 2>/dev/null; then
            echo "❌ Found eval() with user input (code injection risk)"
            FOUND_ISSUES=1
          fi
          
          # Check for shell=True in subprocess (Python)
          if rg -n "shell\s*=\s*True" . --glob "**/*.py" --glob "!tests/**" 2>/dev/null; then
            echo "⚠️ Found shell=True in subprocess (review for injection risks)"
            # Warning only, don't fail
          fi
          
          if [ $FOUND_ISSUES -eq 1 ]; then
            echo ""
            echo "Fix these security issues before merging."
            exit 1
          else
            echo "✅ No critical dangerous patterns detected."
          fi

  node-python-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect if Node/TS files changed
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx|js|jsx|json)$|package\.json|package-lock\.json|tsconfig\.json' || echo "")
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(ts|tsx|js|jsx|json)$|package\.json|package-lock\.json|tsconfig\.json' || echo "")
          fi
          
          if [ -n "$CHANGED" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Node/TS files changed, running checks"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No Node/TS files changed, skipping checks"
          fi

      - name: Setup Node
        if: steps.filter.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        if: steps.filter.outputs.changed == 'true'
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f package.json ]; then
            npm install
          else
            echo "No package.json found"
            exit 1
          fi

      - name: Run linter
        if: steps.filter.outputs.changed == 'true'
        run: |
          if [ -f package.json ]; then
            if node -e "const p=require('./package.json'); process.exit(p.scripts && p.scripts.lint ? 0 : 1)"; then
              npm run lint
            else
              echo "⚠️ No lint script defined in package.json"
            fi
          fi

      - name: Run tests
        if: steps.filter.outputs.changed == 'true'
        run: |
          if [ -f package.json ]; then
            if node -e "const p=require('./package.json'); process.exit(p.scripts && p.scripts.test ? 0 : 1)"; then
              npm test
            else
              echo "❌ No test script defined in package.json"
              exit 1
            fi
          fi

      - name: Run build
        if: steps.filter.outputs.changed == 'true'
        run: |
          if [ -f package.json ]; then
            if node -e "const p=require('./package.json'); process.exit(p.scripts && p.scripts.build ? 0 : 1)"; then
              npm run build
            else
              echo "⚠️ No build script defined in package.json"
            fi
          fi

  # Path-filtered: Prisma schema validation
  prisma-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect if Prisma files changed
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.prisma$|prisma/migrations/' || echo "")
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '\.prisma$|prisma/migrations/' || echo "")
          fi
          
          if [ -n "$CHANGED" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Prisma files changed, running validation"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No Prisma files changed, skipping validation"
          fi

      - name: Setup Node
        if: steps.filter.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Prisma
        if: steps.filter.outputs.changed == 'true'
        run: npm install -g prisma

      - name: Validate Prisma schema
        if: steps.filter.outputs.changed == 'true'
        run: |
          if find . -name "schema.prisma" -o -name "*.prisma" | grep -q .; then
            for schema in $(find . -name "schema.prisma" -o -name "*.prisma"); do
              echo "Validating $schema..."
              prisma validate --schema="$schema"
            done
          else
            echo "No Prisma schema files found"
          fi

  # Path-filtered: Rust jobs
  rust-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect if Rust files changed
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.rs$|Cargo\.(toml|lock)' || echo "")
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '\.rs$|Cargo\.(toml|lock)' || echo "")
          fi
          
          if [ -n "$CHANGED" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Rust files changed, running checks"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No Rust files changed, skipping checks"
          fi

      - name: Setup Rust
        if: steps.filter.outputs.changed == 'true'
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: Run cargo fmt check
        if: steps.filter.outputs.changed == 'true'
        run: cargo fmt --all -- --check

      - name: Run cargo clippy
        if: steps.filter.outputs.changed == 'true'
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run cargo test
        if: steps.filter.outputs.changed == 'true'
        run: cargo test --all-features

      - name: Run cargo build
        if: steps.filter.outputs.changed == 'true'
        run: cargo build --release

  # Python checks
  python-ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect if Python files changed
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.py$|requirements\.txt' || echo "")
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E '\.py$|requirements\.txt' || echo "")
          fi
          
          if [ -n "$CHANGED" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Python files changed, running checks"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No Python files changed, skipping checks"
          fi

      - name: Setup Python
        if: steps.filter.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        if: steps.filter.outputs.changed == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          python -m pip install pytest || true

      - name: Run Python tests
        if: steps.filter.outputs.changed == 'true'
        run: |
          if find tests -name "*.py" -type f 2>/dev/null | grep -q .; then
            pytest -q tests
          else
            echo "ℹ️ No Python tests found"
          fi
